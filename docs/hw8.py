import gradio as gr
import numpy as np

# å¸¸æ•¸å®šç¾© (ä½¿ç”¨å¸¸è¦‹çš„æ•™å­¸å¸¸æ•¸)
# è‡ªç”±ç©ºé–“æ ¡æ­£å› å­ (Free-Air Correction Factor)
FAC_FACTOR = 0.3086   # mGal/m

# ----------------------------------------------------------------------
# æ ¸å¿ƒè¨ˆç®—å‡½æ•¸
# ----------------------------------------------------------------------

def calculate_theoretical_gravity(latitude_deg):
    """
    è¨ˆç®—ç†è«–é‡åŠ› (g_phi) åªèˆ‡ç·¯åº¦æœ‰é—œã€‚
    
    ä½¿ç”¨ IGSN71 / GRS67 ç°¡åŒ–å…¬å¼ (çµæœå–®ä½ç‚º mGal):
    g_phi (mGal) = 978031.85 * (1 + 0.0053024 * sin^2(phi) - 0.0000059 * sin^2(2*phi))
    """
    
    phi_rad = np.deg2rad(latitude_deg)
    
    # æ ¹æ“š GRS67/IGSN71 çš„ç°¡åŒ–å…¬å¼
    g_phi_mgal = 978031.85 * (1 + 0.0053024 * np.sin(phi_rad)**2 - 0.0000059 * np.sin(2 * phi_rad)**2)
    
    return g_phi_mgal

def calculate_free_air_correction(elevation_m):
    """
    è¨ˆç®—è‡ªç”±ç©ºé–“æ ¡æ­£é … (Free-Air Correction, FAC)ã€‚
    
    FAC = 0.3086 * H  (å–®ä½: mGal)
    """
    fac_mgal = FAC_FACTOR * elevation_m
    return fac_mgal

def calculate_gravity_values(measured_gravity, latitude_deg, elevation_m):
    """
    è¨ˆç®—ç†è«–é‡åŠ›ã€è‡ªç”±ç©ºé–“æ ¡æ­£ã€ä»¥åŠè‡ªç”±ç©ºé–“é‡åŠ›ç•°å¸¸ã€‚
    """
    # 1. è¨ˆç®—ç†è«–é‡åŠ› (åªè€ƒæ…®ç·¯åº¦)
    g_theoretical = calculate_theoretical_gravity(latitude_deg)
    
    # 2. è¨ˆç®—è‡ªç”±ç©ºé–“æ ¡æ­£é …
    fac_correction = calculate_free_air_correction(elevation_m)
    
    # 3. è¨ˆç®—è‡ªç”±ç©ºé–“é‡åŠ› (Free-Air Gravity, g_FSA)
    # g_FSA = g_obs + FAC 
    g_FSA = measured_gravity + fac_correction
    
    # 4. è¨ˆç®—è‡ªç”±ç©ºé–“é‡åŠ›ç•°å¸¸ (Free-Air Anomaly, FAA)
    # FAA = g_FSA - g_theoretical 
    faa = g_FSA - g_theoretical
    
    # æ ¼å¼åŒ–è¼¸å‡º
    g_theoretical_mgal_str = f"{g_theoretical:.2f} mGal"
    fac_correction_mgal_str = f"+{fac_correction:.2f} mGal"
    g_FSA_mgal_str = f"{g_FSA:.2f} mGal"
    faa_mgal_str = f"{faa:.2f} mGal"
    
    # äº’å‹•å¼è§£é‡‹ (Markdown) - ä¿®æ­£äº† f-string å’Œ LaTeX è½‰ç¾©å•é¡Œ
    explanation = f"""
    ### ğŸ”¬ ä½ çš„é‡åŠ›æ¢å‹˜çµæœåˆ†æ
    | é …ç›® | æ•¸å€¼ | å–®ä½ |
    | :--- | :--- | :--- |
    | è§€æ¸¬é‡åŠ› ($g_{{\\text{{obs}}}}$) | **{measured_gravity:.2f}** | **mGal** |
    | è§€æ¸¬é»ç·¯åº¦ ($\phi$) | **{latitude_deg}Â°** | **åº¦** |
    | è§€æ¸¬é»é«˜ç¨‹ ($H$) | **{elevation_m:.2f}** | **å…¬å°º** |
    
    ---
    
    #### 1. ç†è«–é‡åŠ› ($\mathbf{{g_{{\phi}}}}$) ğŸŒ
    ç†è«–é‡åŠ›æ˜¯åœ°çƒçš„**ç†æƒ³æ¨¡å‹**åœ¨**å¤§åœ°æ°´æº–é¢**ï¼ˆ$H=0$ï¼‰ä¸Šï¼Œ**åªè€ƒæ…®ç·¯åº¦**å°é‡åŠ›å½±éŸ¿çš„é æ¸¬å€¼ã€‚
    - **è¨ˆç®—å€¼ï¼š** **{g_theoretical:.2f} mGal**
    - ğŸ’¡ **è€å¸«çš„æå•ï¼š** ç†è«–é‡åŠ›çš„è®ŠåŒ–åæ˜ äº†åœ°çƒçš„å“ªå…©ç¨®ç‰©ç†ç‰¹æ€§ï¼Ÿ (æç¤ºï¼šå½¢ç‹€å’Œé‹å‹•)
    #### 2. è‡ªç”±ç©ºé–“æ ¡æ­£ ($\mathbf{{FAC}}$) â¬†ï¸
    é€™å€‹æ ¡æ­£æ˜¯ç‚ºäº†**ç§»é™¤æ¸¬é‡é»é«˜ç¨‹ ($H$) å°é‡åŠ›çš„å½±éŸ¿**ï¼ˆè·é›¢åœ°å¿ƒè®Šé ï¼‰ã€‚å› æ­¤ï¼Œæ ¡æ­£é …æ˜¯**åŠ å›**åˆ°è§€æ¸¬å€¼ä¸Šï¼ˆæ­£å€¼ï¼‰ã€‚
    - **æ ¡æ­£é …ï¼š** **{fac_correction_mgal_str}**
    - ğŸ”— **å…¬å¼ï¼š** $FAC = 0.3086 \\times H$ (mGal)
    - âš ï¸ **é—œéµå‡è¨­ï¼š** $FAC$ å‡è¨­è§€æ¸¬é» $H$ ä»¥ä¸‹åˆ°å¤§åœ°æ°´æº–é¢ä¹‹é–“çš„ç©ºé–“æ˜¯**çœŸç©º**æˆ–**ç©ºæ°£**ã€‚
    #### 3. è‡ªç”±ç©ºé–“é‡åŠ› ($\mathbf{{g_{{\\text{{FSA}}}}}}$) ğŸš€
    é€™æ˜¯å°‡**è§€æ¸¬é‡åŠ›**ç¶“**è‡ªç”±ç©ºé–“æ ¡æ­£**å¾Œï¼Œæ­¸ç®—åˆ° $H=0$ è™•çš„é‡åŠ›å€¼ã€‚
    - **è¨ˆç®—å€¼ï¼š** **{g_FSA:.2f} mGal**
    - ğŸ”— **å…¬å¼ï¼š** $g_{{\\text{{FSA}}}} = g_{{\\text{{obs}}}} + FAC$
    #### 4. è‡ªç”±ç©ºé–“é‡åŠ›ç•°å¸¸ ($\mathbf{{FAA}}$) ğŸ¯
    $FAA$ æ¯”è¼ƒäº†**æ ¡æ­£å¾Œé‡åŠ›** ($g_{{\\text{{FSA}}}}$) èˆ‡**ç†è«–é‡åŠ›** ($g_{{\phi}}$) ä¹‹é–“çš„å·®ç•°ã€‚
    - **è¨ˆç®—å€¼ï¼š** **{faa:.2f} mGal**
    - ğŸ”— **å…¬å¼ï¼š** $FAA = g_{{\\text{{FSA}}}} - g_{{\phi}}$
    - **æ„ç¾©ï¼š** $FAA$ æ’é™¤äº†ç·¯åº¦å’Œé«˜åº¦çš„å½±éŸ¿ï¼Œä½†**ä»åŒ…å«æ¸¬é‡é»ä¸‹æ–¹å²©çŸ³çš„è³ªé‡ï¼ˆåœ°å½¢ï¼‰å½±éŸ¿**ã€‚
    ---
    **äº’å‹•ç’°ç¯€ï¼š**
    1. ä¿æŒé«˜ç¨‹ä¸è®Šï¼Œå°‡ç·¯åº¦å¾ 0Â° ç§»åˆ° 90Â°ï¼Œè§€å¯Ÿç†è«–é‡åŠ› $g_{{\phi}}$ å¦‚ä½•å¾ç´„ 978 Gal å¢è‡³ 983 Galã€‚
    2. ä¿æŒç·¯åº¦ä¸è®Šï¼Œå°‡é«˜ç¨‹ $H$ å¾ 0m å¢åŠ åˆ° 1000mï¼Œè§€å¯Ÿ $FAC$ å¦‚ä½•å¾ 0 å¢åŠ åˆ°ç´„ 308.6 mGalã€‚
    """

    return g_theoretical_mgal_str, fac_correction_mgal_str, g_FSA_mgal_str, faa_mgal_str, explanation

# ----------------------------------------------------------------------
# Gradio ä»‹é¢è¨­å®š
# ----------------------------------------------------------------------

# è¼¸å…¥ä»‹é¢
inputs = [
    gr.Number(label="è§€æ¸¬é‡åŠ› (g_obs) [mGal]", value=980000.00, minimum=975000, maximum=985000, step=0.01),
    gr.Slider(label="æ¸¬é‡é»ç·¯åº¦ (Ï†) [åº¦]", minimum=0.0, maximum=90.0, value=25.0, step=0.1),
    gr.Number(label="æ¸¬é‡é»é«˜ç¨‹ (H) [å…¬å°º]", value=100.0, minimum=0.0, maximum=5000.0, step=0.1)
]

# è¼¸å‡ºä»‹é¢
outputs = [
    gr.Textbox(label="1. ç†è«–é‡åŠ› (g_phi)"),
    gr.Textbox(label="2. è‡ªç”±ç©ºé–“æ ¡æ­£é … (FAC)"),
    gr.Textbox(label="3. è‡ªç”±ç©ºé–“é‡åŠ› (g_FSA)"),
    gr.Textbox(label="4. è‡ªç”±ç©ºé–“é‡åŠ›ç•°å¸¸ (FAA)"),
    gr.Markdown(label="ğŸš€ è€å¸«çš„äº’å‹•å¼è§£æèˆ‡æå•")
]

# ä»‹é¢æ¨™é¡Œèˆ‡æè¿°
title = "ğŸŒ é‡åŠ›æ¢å‹˜æ•™å®¤ï¼šç†è«–é‡åŠ›èˆ‡è‡ªç”±ç©ºé–“æ ¡æ­£"
description = """
æ­¡è¿ä¾†åˆ°é‡åŠ›æ¢å‹˜äº’å‹•æ•™å®¤ï¼è«‹è¼¸å…¥è§€æ¸¬é»çš„åƒæ•¸ï¼Œç³»çµ±å°‡ç‚ºä½ è¨ˆç®—**ç†è«–é‡åŠ›**ã€**è‡ªç”±ç©ºé–“æ ¡æ­£**ï¼Œä¸¦å¾—åˆ°**è‡ªç”±ç©ºé–“é‡åŠ›ç•°å¸¸**ã€‚
é€™ä¸€æ­¥æ˜¯ç‚ºäº†å°‡ä½ æ¸¬é‡åˆ°çš„é‡åŠ›å€¼ $g_{obs}$ æ­¸ç®—åˆ°**å¤§åœ°æ°´æº–é¢**ä¸Šï¼Œä»¥ä¾¿å’Œ**ç†è«–é‡åŠ›**é€²è¡Œæ¯”è¼ƒã€‚
æ‰€æœ‰é‡åŠ›æ•¸å€¼å–®ä½çš†ä»¥ **mGal** (æ¯«ä¼½) ç‚ºä¸»ã€‚
"""

# å»ºç«‹ Gradio ä»‹é¢
iface = gr.Interface(
    fn=calculate_gravity_values,
    inputs=inputs,
    outputs=outputs,
    title=title,
    description=description,
    live=True # å•Ÿç”¨å³æ™‚æ›´æ–°
)

# å•Ÿå‹•ä»‹é¢
if __name__ == "__main__":
    iface.launch()
